services:
  # 迁移助手（仅用于从旧 plugin DB 自动迁移到 Backend）
  # - 默认不随主 compose 启动；需要时手动叠加本文件启动
  # - Backend 通过 PLUGIN_API_BASE_URL=http://plugin-env:8045 获取 DB_HOST/DB_PORT/DB_NAME/DB_USER/DB_PASSWORD
  plugin-env:
    build:
      context: ../AntiHub-plugin
      dockerfile: Dockerfile
    container_name: antihub-plugin-env
    environment:
      # 旧 plugin DB 连接信息（Env Exporter 读取并通过 HTTP 返回给 Backend）
      # 支持两套命名：DB_*（推荐）与 PLUGIN_DB_*（兼容旧部署）
      DB_HOST: ${DB_HOST:-}
      DB_PORT: ${DB_PORT:-}
      DB_NAME: ${DB_NAME:-}
      DB_USER: ${DB_USER:-}
      DB_PASSWORD: ${DB_PASSWORD:-}

      PLUGIN_DB_HOST: ${PLUGIN_DB_HOST:-}
      PLUGIN_DB_PORT: ${PLUGIN_DB_PORT:-}
      PLUGIN_DB_NAME: ${PLUGIN_DB_NAME:-}
      PLUGIN_DB_USER: ${PLUGIN_DB_USER:-}
      PLUGIN_DB_PASSWORD: ${PLUGIN_DB_PASSWORD:-}

      # 可选：与 Backend 的 PLUGIN_ENV_EXPORT_TOKEN 一致（对应请求头 X-Migration-Token）
      PLUGIN_ENV_EXPORT_TOKEN: ${PLUGIN_ENV_EXPORT_TOKEN:-}
      # 兼容：也可以直接复用旧部署的 PLUGIN_ADMIN_API_KEY（Env Exporter 会优先使用 PLUGIN_ENV_EXPORT_TOKEN）
      PLUGIN_ADMIN_API_KEY: ${PLUGIN_ADMIN_API_KEY:-}

    restart: unless-stopped
