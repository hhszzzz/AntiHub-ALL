name: Build & Push Docker Images

on:
  push:
    branches: [main, Beta]
    tags: ["v*", "V*"]
  workflow_dispatch:

concurrency:
  group: docker-images-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io

jobs:
  changes:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      web: ${{ steps.normalize.outputs.web }}
      backend: ${{ steps.normalize.outputs.backend }}
      plugin_env: ${{ steps.normalize.outputs.plugin_env }}
      tag_name: ${{ steps.tag.outputs.tag_name }}
    steps:
      - name: Force build all on manual dispatch or tag
        id: force
        if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v') || startsWith(github.ref, 'refs/tags/V')
        run: |
          echo "force_all=true" >> $GITHUB_OUTPUT
          echo "web=true" >> $GITHUB_OUTPUT
          echo "backend=true" >> $GITHUB_OUTPUT
          echo "plugin_env=true" >> $GITHUB_OUTPUT

      - name: Checkout
        if: steps.force.outputs.force_all != 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: false
          filter: blob:none

      - name: Check for changes
        if: steps.force.outputs.force_all != 'true'
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            web:
              - 'AntiHub/**'
              - '!AntiHub/**/*.md'
              - 'AntiHook/**'
              - '!AntiHook/**/*.md'
            backend:
              - 'AntiHub-Backend/**'
              - '!AntiHub-Backend/**/*.md'
            plugin_env:
              - 'AntiHub-plugin/**'
              - '!AntiHub-plugin/**/*.md'

      - name: Normalize build outputs
        id: normalize
        run: |
          # force 有值时使用 force 输出；否则使用 filter 输出（空则转为 false）
          if [ "${{ steps.force.outputs.web }}" = "true" ]; then
            echo "web=true" >> $GITHUB_OUTPUT
          elif [ "${{ steps.filter.outputs.web }}" = "true" ]; then
            echo "web=true" >> $GITHUB_OUTPUT
          else
            echo "web=false" >> $GITHUB_OUTPUT
          fi

          if [ "${{ steps.force.outputs.backend }}" = "true" ]; then
            echo "backend=true" >> $GITHUB_OUTPUT
          elif [ "${{ steps.filter.outputs.backend }}" = "true" ]; then
            echo "backend=true" >> $GITHUB_OUTPUT
          else
            echo "backend=false" >> $GITHUB_OUTPUT
          fi

          if [ "${{ steps.force.outputs.plugin_env }}" = "true" ]; then
            echo "plugin_env=true" >> $GITHUB_OUTPUT
          elif [ "${{ steps.filter.outputs.plugin_env }}" = "true" ]; then
            echo "plugin_env=true" >> $GITHUB_OUTPUT
          else
            echo "plugin_env=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract and normalize tag name
        id: tag
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          LOWER_TAG=$(echo "$TAG_NAME" | tr '[:upper:]' '[:lower:]')
          echo "tag_name=$LOWER_TAG" >> $GITHUB_OUTPUT

  # ============ Web ============
  build-web:
    needs: changes
    if: needs.changes.outputs.web == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v') || startsWith(github.ref, 'refs/tags/V')
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            platform: linux/amd64
            suffix: amd64
          - runner: ubuntu-24.04-arm
            platform: linux/arm64
            suffix: arm64
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push (web-${{ matrix.suffix }})
        uses: docker/build-push-action@v6
        with:
          context: ./AntiHub
          file: ./AntiHub/Dockerfile
          build-contexts: |
            antihook=./AntiHook
          push: true
          platforms: ${{ matrix.platform }}
          tags: ${{ env.REGISTRY }}/${{ github.repository_owner }}/antihub-web:build-${{ github.run_id }}-${{ matrix.suffix }}
          cache-from: type=gha,scope=web-${{ matrix.suffix }}
          cache-to: type=gha,mode=max,scope=web-${{ matrix.suffix }}

  merge-web:
    needs: [changes, build-web]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push multi-arch manifest (web)
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ github.repository_owner }}/antihub-web"
          BUILD_TAG="build-${{ github.run_id }}"

          # 根据分支决定标签
          if [[ "${{ github.ref_name }}" == "Beta" ]]; then
            LATEST_TAG="beta"
          else
            LATEST_TAG="latest"
          fi

          docker buildx imagetools create -t ${IMAGE}:${LATEST_TAG} \
            ${IMAGE}:${BUILD_TAG}-amd64 \
            ${IMAGE}:${BUILD_TAG}-arm64

          docker buildx imagetools create -t ${IMAGE}:sha-${GITHUB_SHA::7} \
            ${IMAGE}:${BUILD_TAG}-amd64 \
            ${IMAGE}:${BUILD_TAG}-arm64

          # tag 推送额外打版本号
          if [[ "${{ needs.changes.outputs.tag_name }}" != "" ]]; then
            docker buildx imagetools create -t ${IMAGE}:${{ needs.changes.outputs.tag_name }} \
              ${IMAGE}:${BUILD_TAG}-amd64 \
              ${IMAGE}:${BUILD_TAG}-arm64
          fi

  # ============ Backend ============
  build-backend:
    needs: changes
    if: needs.changes.outputs.backend == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v') || startsWith(github.ref, 'refs/tags/V')
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            platform: linux/amd64
            suffix: amd64
          - runner: ubuntu-24.04-arm
            platform: linux/arm64
            suffix: arm64
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push (backend-${{ matrix.suffix }})
        uses: docker/build-push-action@v6
        with:
          context: ./AntiHub-Backend
          file: ./AntiHub-Backend/Dockerfile
          push: true
          platforms: ${{ matrix.platform }}
          tags: ${{ env.REGISTRY }}/${{ github.repository_owner }}/antihub-backend:build-${{ github.run_id }}-${{ matrix.suffix }}
          cache-from: type=gha,scope=backend-${{ matrix.suffix }}
          cache-to: type=gha,mode=max,scope=backend-${{ matrix.suffix }}

  merge-backend:
    needs: [changes, build-backend]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push multi-arch manifest (backend)
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ github.repository_owner }}/antihub-backend"
          BUILD_TAG="build-${{ github.run_id }}"

          # 根据分支决定标签
          if [[ "${{ github.ref_name }}" == "Beta" ]]; then
            LATEST_TAG="beta"
          else
            LATEST_TAG="latest"
          fi

          docker buildx imagetools create -t ${IMAGE}:${LATEST_TAG} \
            ${IMAGE}:${BUILD_TAG}-amd64 \
            ${IMAGE}:${BUILD_TAG}-arm64

          docker buildx imagetools create -t ${IMAGE}:sha-${GITHUB_SHA::7} \
            ${IMAGE}:${BUILD_TAG}-amd64 \
            ${IMAGE}:${BUILD_TAG}-arm64

          if [[ "${{ needs.changes.outputs.tag_name }}" != "" ]]; then
            docker buildx imagetools create -t ${IMAGE}:${{ needs.changes.outputs.tag_name }} \
              ${IMAGE}:${BUILD_TAG}-amd64 \
              ${IMAGE}:${BUILD_TAG}-arm64
          fi

  # ============ Plugin Env (Migration Helper) ============
  build-plugin-env:
    needs: changes
    if: needs.changes.outputs.plugin_env == 'true' || github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/v') || startsWith(github.ref, 'refs/tags/V')
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-latest
            platform: linux/amd64
            suffix: amd64
          - runner: ubuntu-24.04-arm
            platform: linux/arm64
            suffix: arm64
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push (plugin-env-${{ matrix.suffix }})
        uses: docker/build-push-action@v6
        with:
          context: ./AntiHub-plugin
          file: ./AntiHub-plugin/Dockerfile
          push: true
          platforms: ${{ matrix.platform }}
          tags: ${{ env.REGISTRY }}/${{ github.repository_owner }}/antihub-plugin:build-${{ github.run_id }}-${{ matrix.suffix }}
          cache-from: type=gha,scope=plugin-env-${{ matrix.suffix }}
          cache-to: type=gha,mode=max,scope=plugin-env-${{ matrix.suffix }}

  merge-plugin-env:
    needs: [changes, build-plugin-env]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push multi-arch manifest (plugin-env)
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ github.repository_owner }}/antihub-plugin"
          BUILD_TAG="build-${{ github.run_id }}"

          # 根据分支决定标签
          if [[ "${{ github.ref_name }}" == "Beta" ]]; then
            LATEST_TAG="beta"
          else
            LATEST_TAG="latest"
          fi

          docker buildx imagetools create -t ${IMAGE}:${LATEST_TAG} \
            ${IMAGE}:${BUILD_TAG}-amd64 \
            ${IMAGE}:${BUILD_TAG}-arm64

          docker buildx imagetools create -t ${IMAGE}:sha-${GITHUB_SHA::7} \
            ${IMAGE}:${BUILD_TAG}-amd64 \
            ${IMAGE}:${BUILD_TAG}-arm64

          if [[ "${{ needs.changes.outputs.tag_name }}" != "" ]]; then
            docker buildx imagetools create -t ${IMAGE}:${{ needs.changes.outputs.tag_name }} \
              ${IMAGE}:${BUILD_TAG}-amd64 \
              ${IMAGE}:${BUILD_TAG}-arm64
          fi
